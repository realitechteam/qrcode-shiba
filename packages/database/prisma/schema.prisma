generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model User {
  id            String            @id @default(uuid())
  email         String            @unique
  passwordHash  String?
  name          String?
  avatarUrl     String?
  authProvider  AuthProvider      @default(EMAIL)
  providerId    String?
  emailVerified Boolean           @default(false)
  tier          String            @default("FREE")
  createdAt     DateTime          @default(now())
  updatedAt     DateTime          @updatedAt
  referredBy    String?
  role          UserRole          @default(USER)
  bannedAt      DateTime?
  affiliate     AffiliateAccount?
  apiKeys       ApiKey[]
  folders       Folder[]
  orders        Order[]
  qrCodes       QRCode[]
  subscription  Subscription?
  ownedTeams    Team[]            @relation("TeamOwner")
  teamMembers   TeamMember[]

  @@index([email])
  @@index([authProvider, providerId])
  @@index([referredBy])
}

model SystemConfig {
  key       String   @id
  value     String
  updatedAt DateTime @updatedAt
}

model RefreshToken {
  id        String   @id @default(uuid())
  token     String   @unique
  userId    String
  expiresAt DateTime
  createdAt DateTime @default(now())

  @@index([userId])
  @@index([token])
}

model MagicLink {
  id        String   @id @default(uuid())
  email     String   @unique
  token     String   @unique
  expiresAt DateTime
  createdAt DateTime @default(now())

  @@index([token])
  @@index([email])
}

model QRCode {
  id             String     @id @default(uuid())
  userId         String
  shortCode      String     @unique
  name           String?
  type           QRType
  status         QRStatus   @default(ACTIVE)
  styling        Json       @default("{}")
  destinationUrl String?
  imageUrl       String?
  isDynamic      Boolean    @default(false)
  expiresAt      DateTime?
  passwordHash   String?
  scanCount      Int        @default(0)
  createdAt      DateTime   @default(now())
  updatedAt      DateTime   @updatedAt
  folderId       String?
  folder         Folder?    @relation(fields: [folderId], references: [id])
  user           User       @relation(fields: [userId], references: [id], onDelete: Cascade)
  content        QRContent?
  scans          Scan[]

  @@index([userId])
  @@index([shortCode])
  @@index([createdAt(sort: Desc)])
  @@index([type])
  @@index([status])
}

model QRContent {
  id          String      @id @default(uuid())
  qrId        String      @unique
  contentType ContentType
  data        Json
  fileUrl     String?
  createdAt   DateTime    @default(now())
  updatedAt   DateTime    @updatedAt
  qrCode      QRCode      @relation(fields: [qrId], references: [id], onDelete: Cascade)
}

model Scan {
  id             String   @id @default(uuid())
  qrId           String
  ip             String?
  userAgent      String?
  country        String?
  city           String?
  region         String?
  latitude       Float?
  longitude      Float?
  deviceType     String?
  os             String?
  osVersion      String?
  browser        String?
  browserVersion String?
  referer        String?
  language       String?
  scannedAt      DateTime @default(now())
  qr             QRCode   @relation(fields: [qrId], references: [id], onDelete: Cascade)

  @@index([qrId])
  @@index([scannedAt(sort: Desc)])
  @@index([country])
}

model Plan {
  id             String         @id @default(uuid())
  name           String         @unique
  slug           String         @unique
  description    String?
  priceMonthly   Int
  priceYearly    Int
  dynamicQrLimit Int
  scanLimit      Int
  bulkLimit      Int
  apiAccess      Boolean        @default(false)
  teamMembers    Int            @default(1)
  features       Json           @default("[]")
  isActive       Boolean        @default(true)
  sortOrder      Int            @default(0)
  createdAt      DateTime       @default(now())
  updatedAt      DateTime       @updatedAt
  subscriptions  Subscription[]

  @@index([slug])
  @@index([isActive])
}

model Subscription {
  id                     String             @id @default(uuid())
  userId                 String             @unique
  planId                 String
  status                 SubscriptionStatus @default(ACTIVE)
  startDate              DateTime           @default(now())
  endDate                DateTime
  billingCycle           String?
  paymentProvider        String?
  providerSubscriptionId String?
  cancelAtPeriodEnd      Boolean            @default(false)
  cancelledAt            DateTime?
  createdAt              DateTime           @default(now())
  updatedAt              DateTime           @updatedAt
  payments               Payment[]
  plan                   Plan               @relation(fields: [planId], references: [id])
  user                   User               @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([status])
}

model Payment {
  id             String       @id @default(uuid())
  subscriptionId String
  amount         Int
  currency       String       @default("VND")
  status         String
  provider       String
  providerTxnId  String?
  metadata       Json?
  createdAt      DateTime     @default(now())
  updatedAt      DateTime     @updatedAt
  subscription   Subscription @relation(fields: [subscriptionId], references: [id])

  @@index([subscriptionId])
  @@index([providerTxnId])
}

model Order {
  id              String    @id @default(uuid())
  userId          String
  planId          String
  billingCycle    String
  amount          Int
  currency        String    @default("VND")
  status          String    @default("PENDING")
  paymentProvider String
  transactionId   String?
  paidAt          DateTime?
  metadata        Json?
  createdAt       DateTime  @default(now())
  updatedAt       DateTime  @updatedAt
  user            User      @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([status])
}

model Folder {
  id        String   @id @default(uuid())
  userId    String
  parentId  String?
  name      String
  color     String?
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  parent    Folder?  @relation("FolderHierarchy", fields: [parentId], references: [id])
  children  Folder[] @relation("FolderHierarchy")
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  qrCodes   QRCode[]

  @@index([userId])
  @@index([parentId])
}

model Team {
  id        String       @id @default(uuid())
  name      String
  slug      String       @unique
  ownerId   String
  createdAt DateTime     @default(now())
  updatedAt DateTime     @updatedAt
  owner     User         @relation("TeamOwner", fields: [ownerId], references: [id])
  members   TeamMember[]

  @@index([ownerId])
  @@index([slug])
}

model TeamMember {
  id       String   @id @default(uuid())
  teamId   String
  userId   String
  role     TeamRole @default(VIEWER)
  joinedAt DateTime @default(now())
  team     Team     @relation(fields: [teamId], references: [id], onDelete: Cascade)
  user     User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([teamId, userId])
  @@index([teamId])
  @@index([userId])
}

model ApiKey {
  id         String    @id @default(uuid())
  userId     String
  name       String
  keyHash    String    @unique
  keyPrefix  String
  lastUsedAt DateTime?
  expiresAt  DateTime?
  isActive   Boolean   @default(true)
  createdAt  DateTime  @default(now())
  user       User      @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([keyHash])
}

model AffiliateAccount {
  id             String                @id @default(uuid())
  userId         String                @unique
  totalEarnings  Int                   @default(0)
  pendingBalance Int                   @default(0)
  paidBalance    Int                   @default(0)
  status         String                @default("ACTIVE")
  bankName       String?
  bankAccount    String?
  bankHolder     String?
  createdAt      DateTime              @default(now())
  updatedAt      DateTime              @updatedAt
  user           User                  @relation(fields: [userId], references: [id], onDelete: Cascade)
  commissions    AffiliateCommission[]
  links          AffiliateLink[]
  payouts        AffiliatePayout[]
  referrals      AffiliateReferral[]

  @@index([userId])
}

model AffiliateLink {
  id             String              @id @default(uuid())
  affiliateId    String
  referralCode   String              @unique
  label          String?
  commissionRate Float
  discountRate   Float               @default(0)
  clickCount     Int                 @default(0)
  referralCount  Int                 @default(0)
  isActive       Boolean             @default(true)
  createdAt      DateTime            @default(now())
  updatedAt      DateTime            @updatedAt
  affiliate      AffiliateAccount    @relation(fields: [affiliateId], references: [id], onDelete: Cascade)
  referrals      AffiliateReferral[]

  @@index([referralCode])
  @@index([affiliateId])
}

model AffiliateReferral {
  id             String           @id @default(uuid())
  affiliateId    String
  referredUserId String           @unique
  status         String           @default("REGISTERED")
  convertedAt    DateTime?
  createdAt      DateTime         @default(now())
  linkId         String?
  affiliate      AffiliateAccount @relation(fields: [affiliateId], references: [id], onDelete: Cascade)
  link           AffiliateLink?   @relation(fields: [linkId], references: [id])

  @@index([affiliateId])
  @@index([linkId])
}

model AffiliateCommission {
  id          String           @id @default(uuid())
  affiliateId String
  orderId     String
  amount      Int
  rate        Float
  status      String           @default("PENDING")
  createdAt   DateTime         @default(now())
  affiliate   AffiliateAccount @relation(fields: [affiliateId], references: [id], onDelete: Cascade)

  @@index([affiliateId])
  @@index([status])
}

model AffiliatePayout {
  id          String           @id @default(uuid())
  affiliateId String
  amount      Int
  method      String
  status      String           @default("PENDING")
  processedAt DateTime?
  note        String?
  createdAt   DateTime         @default(now())
  affiliate   AffiliateAccount @relation(fields: [affiliateId], references: [id], onDelete: Cascade)

  @@index([affiliateId])
}

enum AuthProvider {
  EMAIL
  GOOGLE
  FACEBOOK
  ZALO
}

enum QRType {
  URL
  TEXT
  VCARD
  WIFI
  EMAIL
  SMS
  PHONE
  LOCATION
  PDF
  IMAGE
  VIDEO
  MENU
  LANDING_PAGE
  SOCIAL_LINKS
  APP_STORE
  EVENT
}

enum QRStatus {
  ACTIVE
  EXPIRED
  ARCHIVED
  DISABLED
}

enum ContentType {
  URL
  TEXT
  VCARD
  WIFI
  FILE
  GALLERY
  MENU
  LANDING
}

enum SubscriptionStatus {
  ACTIVE
  PAST_DUE
  CANCELED
  EXPIRED
  TRIALING
}

enum TeamRole {
  OWNER
  ADMIN
  EDITOR
  VIEWER
}

enum UserRole {
  USER
  ADMIN
}
